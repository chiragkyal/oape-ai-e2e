<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OAPE Operator Feature Developer</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5;
         display: flex; justify-content: center; padding: 40px 16px; }
  .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.1);
          padding: 32px; max-width: 720px; width: 100%; }
  h1 { font-size: 1.4rem; margin-bottom: 4px; }
  p.sub { color: #666; font-size: .9rem; margin-bottom: 24px; }
  label { display: block; font-weight: 600; margin-bottom: 6px; font-size: .9rem; }
  input[type=text] { width: 100%; padding: 10px 12px; border: 1px solid #ccc;
                   border-radius: 6px; font-size: .95rem; }
  input[type=text]:focus { outline: none; border-color: #4a90d9; }
  button { margin-top: 16px; padding: 10px 24px; background: #4a90d9; color: #fff;
           border: none; border-radius: 6px; font-size: .95rem; cursor: pointer; }
  button:disabled { background: #aaa; cursor: not-allowed; }
  .spinner { display: inline-block; width: 18px; height: 18px;
             border: 3px solid #ccc; border-top-color: #4a90d9;
             border-radius: 50%; animation: spin .8s linear infinite;
             vertical-align: middle; margin-right: 8px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  #status { margin-top: 20px; font-size: .9rem; color: #555; }

  /* Workflow phase tracker */
  .phases { margin-top: 16px; display: none; }
  .phase { display: flex; align-items: center; gap: 8px; padding: 6px 0;
           font-size: .85rem; color: #999; }
  .phase.active { color: #4a90d9; font-weight: 600; }
  .phase.done { color: #2E7D32; }
  .phase.failed { color: #c0392b; }
  .phase-icon { width: 20px; text-align: center; flex-shrink: 0; }
  .phase.active .phase-icon::after { content: '\25B6'; }
  .phase.done .phase-icon::after { content: '\2713'; }
  .phase.failed .phase-icon::after { content: '\2717'; }
  .phase:not(.active):not(.done):not(.failed) .phase-icon::after { content: '\25CB'; }

  #conversation { margin-top: 16px; background: #fafafa; border: 1px solid #e0e0e0;
                  border-radius: 6px; max-height: 500px; overflow-y: auto;
                  display: none; }
  #conversation .msg { padding: 10px 14px; border-bottom: 1px solid #eee;
                       font-size: .85rem; line-height: 1.5; }
  #conversation .msg:last-child { border-bottom: none; }
  .msg-text { color: #333; }
  .msg-text .label { font-weight: 600; color: #4a90d9; margin-right: 6px; }
  .msg-tool { color: #8B6914; background: #FFF8E7; font-family: monospace; font-size: .82rem; }
  .msg-tool-result { color: #555; background: #f5f5f5; font-family: monospace;
                     font-size: .82rem; white-space: pre-wrap; word-break: break-word; }
  .msg-thinking { color: #7B1FA2; background: #F3E5F5; font-style: italic; }
  .msg-result { color: #2E7D32; background: #E8F5E9; font-weight: 600; }
  .msg-other { color: #888; font-size: .8rem; }
  #output { margin-top: 16px; background: #1e1e1e; color: #d4d4d4;
            padding: 16px; border-radius: 6px; font-family: monospace;
            font-size: .85rem; white-space: pre-wrap; word-break: break-word;
            max-height: 500px; overflow-y: auto; display: none; }
  .error { color: #c0392b; }
  .content-preview { max-height: 120px; overflow: hidden; position: relative; }
  .content-preview.expanded { max-height: none; }
  .toggle-expand { color: #4a90d9; cursor: pointer; font-size: .8rem;
                   display: inline-block; margin-top: 4px; }
</style>
</head>
<body>
<div class="card">
  <h1>OAPE Operator Feature Developer</h1>
  <p class="sub">Full workflow: API types, controller, and E2E tests from an Enhancement Proposal</p>
  <form id="epForm">
    <label for="ep_url">Enhancement Proposal PR URL</label>
    <input type="text" id="ep_url" name="ep_url"
           placeholder="https://github.com/openshift/enhancements/pull/1234" required>
    <button type="submit" id="submitBtn">Run Workflow</button>
  </form>
  <div id="status"></div>
  <div class="phases" id="phases">
    <div class="phase" data-phase="detect">
      <span class="phase-icon"></span>
      <span>Phase 0: Detect target repository</span>
    </div>
    <div class="phase" data-phase="clone">
      <span class="phase-icon"></span>
      <span>Phase 1: Clone repository</span>
    </div>
    <div class="phase" data-phase="api-types">
      <span class="phase-icon"></span>
      <span>Phase 2: PR #1 &mdash; API types + tests</span>
    </div>
    <div class="phase" data-phase="controller">
      <span class="phase-icon"></span>
      <span>Phase 3: PR #2 &mdash; Controller implementation</span>
    </div>
    <div class="phase" data-phase="e2e">
      <span class="phase-icon"></span>
      <span>Phase 4: PR #3 &mdash; E2E tests</span>
    </div>
    <div class="phase" data-phase="summary">
      <span class="phase-icon"></span>
      <span>Phase 5: Summary</span>
    </div>
  </div>
  <div id="conversation"></div>
  <pre id="output"></pre>
</div>
<script>
const form     = document.getElementById('epForm');
const btn      = document.getElementById('submitBtn');
const statusEl = document.getElementById('status');
const phasesEl = document.getElementById('phases');
const convEl   = document.getElementById('conversation');
const outputEl = document.getElementById('output');

function escapeHtml(text) {
  const d = document.createElement('div');
  d.textContent = text;
  return d.innerHTML;
}

function truncate(str, maxLen) {
  if (!str) return '';
  return str.length <= maxLen ? str : str.substring(0, maxLen) + '\u2026';
}

// Phase detection from agent text output
const PHASE_PATTERNS = [
  { phase: 'detect',     pattern: /phase\s*0|detect.*repo/i },
  { phase: 'clone',      pattern: /phase\s*1|clone.*repo|oape:init/i },
  { phase: 'api-types',  pattern: /phase\s*2|pr\s*#?1|api.types|api.generate(?!-t)/i },
  { phase: 'controller', pattern: /phase\s*3|pr\s*#?2|controller|api.implement/i },
  { phase: 'e2e',        pattern: /phase\s*4|pr\s*#?3|e2e.gen/i },
  { phase: 'summary',    pattern: /phase\s*5|workflow\s*complete|summary/i },
];

let currentPhase = null;

function updatePhase(text) {
  if (!text) return;
  for (const {phase, pattern} of PHASE_PATTERNS) {
    if (pattern.test(text)) {
      if (phase !== currentPhase) {
        // Mark previous as done
        if (currentPhase) {
          const prev = phasesEl.querySelector(`[data-phase="${currentPhase}"]`);
          if (prev) { prev.classList.remove('active'); prev.classList.add('done'); }
        }
        currentPhase = phase;
        const el = phasesEl.querySelector(`[data-phase="${phase}"]`);
        if (el) { el.classList.add('active'); }
      }
      break;
    }
  }
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const epUrl = document.getElementById('ep_url').value.trim();
  if (!epUrl) return;

  btn.disabled = true;
  currentPhase = null;
  outputEl.style.display = 'none';
  outputEl.textContent = '';
  convEl.style.display = 'none';
  convEl.innerHTML = '';
  phasesEl.style.display = 'block';
  // Reset phase indicators
  phasesEl.querySelectorAll('.phase').forEach(p => {
    p.classList.remove('active', 'done', 'failed');
  });
  statusEl.innerHTML = '<span class="spinner"></span> Submitting workflow\u2026';

  try {
    const body = new URLSearchParams({ep_url: epUrl});
    const res = await fetch('/submit', {method: 'POST', body});
    if (!res.ok) { throw new Error((await res.json()).detail || res.statusText); }
    const {job_id} = await res.json();
    statusEl.innerHTML = '<span class="spinner"></span> Connecting to agent stream\u2026';
    streamJob(job_id);
  } catch (err) {
    statusEl.innerHTML = '<span class="error">Error: ' + escapeHtml(err.message) + '</span>';
    btn.disabled = false;
  }
});

function streamJob(jobId) {
  const es = new EventSource('/stream/' + jobId);

  es.addEventListener('message', (e) => {
    const msg = JSON.parse(e.data);
    convEl.style.display = 'block';
    appendMessage(msg);
    updateStatus(msg);
    // Try to detect phase from text or tool use
    if (msg.content) updatePhase(msg.content);
    if (msg.tool_name) updatePhase(msg.tool_name);
  });

  es.addEventListener('complete', (e) => {
    const result = JSON.parse(e.data);
    es.close();
    btn.disabled = false;

    // Mark current phase as done
    if (currentPhase) {
      const el = phasesEl.querySelector(`[data-phase="${currentPhase}"]`);
      if (el) { el.classList.remove('active'); el.classList.add('done'); }
    }

    if (result.status === 'success') {
      statusEl.innerHTML = 'Workflow complete! Cost: $' + (result.cost_usd || 0).toFixed(4);
      if (result.output) {
        outputEl.textContent = result.output;
        outputEl.style.display = 'block';
      }
    } else {
      statusEl.innerHTML = '<span class="error">Failed: '
        + escapeHtml(result.error || 'unknown error') + '</span>';
      // Mark current phase as failed
      if (currentPhase) {
        const el = phasesEl.querySelector(`[data-phase="${currentPhase}"]`);
        if (el) { el.classList.remove('active', 'done'); el.classList.add('failed'); }
      }
    }
  });

  es.addEventListener('error', () => {
    es.close();
    btn.disabled = false;
    if (statusEl.querySelector('.spinner')) {
      statusEl.innerHTML = '<span class="error">Stream connection lost</span>';
    }
  });
}

function appendMessage(msg) {
  const div = document.createElement('div');
  div.className = 'msg';

  if (msg.type === 'assistant' && msg.block_type === 'text') {
    div.classList.add('msg-text');
    div.innerHTML = '<span class="label">Assistant</span>'
      + escapeHtml(msg.content);
  } else if (msg.type === 'assistant' && msg.block_type === 'tool_use') {
    div.classList.add('msg-tool');
    const inputPreview = truncate(JSON.stringify(msg.tool_input), 200);
    div.innerHTML = '&#9881; <b>' + escapeHtml(msg.tool_name) + '</b> '
      + '<span style="color:#aaa">' + escapeHtml(inputPreview) + '</span>';
  } else if (msg.type === 'assistant' && msg.block_type === 'tool_result') {
    div.classList.add('msg-tool-result');
    const content = typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content);
    const preview = truncate(content, 500);
    const prefix = msg.is_error ? '&#10060; ' : '&#10004; ';
    div.innerHTML = prefix + escapeHtml(preview);
  } else if (msg.type === 'assistant' && msg.block_type === 'thinking') {
    div.classList.add('msg-thinking');
    div.textContent = 'Thinking\u2026';
  } else if (msg.type === 'result') {
    div.classList.add('msg-result');
    div.textContent = 'Result received (cost: $'
      + (msg.cost_usd || 0).toFixed(4) + ')';
  } else {
    div.classList.add('msg-other');
    div.textContent = '[' + (msg.type || 'event') + '] '
      + truncate(msg.content || '', 100);
  }

  convEl.appendChild(div);
  convEl.scrollTop = convEl.scrollHeight;
}

function updateStatus(msg) {
  if (msg.type === 'assistant' && msg.block_type === 'text') {
    statusEl.innerHTML = '<span class="spinner"></span> '
      + escapeHtml(truncate(msg.content, 80));
  } else if (msg.type === 'assistant' && msg.block_type === 'tool_use') {
    statusEl.innerHTML = '<span class="spinner"></span> Running: '
      + escapeHtml(msg.tool_name) + '\u2026';
  } else if (msg.type === 'assistant' && msg.block_type === 'thinking') {
    statusEl.innerHTML = '<span class="spinner"></span> Agent is thinking\u2026';
  } else if (msg.type === 'result') {
    statusEl.innerHTML = '<span class="spinner"></span> Finalizing\u2026';
  }
}
</script>
</body>
</html>
